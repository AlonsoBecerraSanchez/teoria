(function(){"use strict";function t(t,e){return t=s[t],e=s[e],t.distance>e.distance?e.distance+12-t.distance:e.distance-t.distance}function e(t,e,n){for(;n>0;n--)t+=e;return t}function n(t,e){if("string"!=typeof t)return null;e=e||{},this.name=t,this.duration={value:e.value||4,dots:e.dots||0},this.accidental={value:0,sign:""};var n,i,r,a,o=/^([a-h])(x|#|bb|b?)(-?\d*)/i,s=/^([a-h])(x|#|bb|b?)([,\']*)$/i,l=t.match(o);if(l&&t===l[0]&&0!==l[3].length)r=l[1].toLowerCase(),a=parseInt(l[3],10),l[2].length>0&&(n=l[2].toLowerCase(),i=M[l[2]]);else{if(t=t.replace(/\u2032/g,"'").replace(/\u0375/g,","),l=t.match(s),!l||t!==l[0])throw Error("Invalid note format");if(r=l[1],a=l[3],l[2].length>0&&(n=l[2].toLowerCase(),i=M[l[2]]),0===a.length)a=r===r.toLowerCase()?3:2;else if(a.match(/^'+$/)){if(r===r.toUpperCase())throw Error("Format must respect the Helmholtz notation");a=3+a.length}else{if(!a.match(/^,+$/))throw Error("Invalid characters after note name.");if(r===r.toLowerCase())throw Error("Format must respect the Helmholtz notation");a=2-a.length}}this.name=r.toLowerCase(),this.octave=a,n&&(this.accidental.value=i,this.accidental.sign=n)}function i(t,e,n){var i=t>=8&&1===t%7?8*(t%7):(t-1)%7+1,r=Math.ceil((t-i)/8),a=d[i-1];if(!(e in f[a.quality]))throw Error("Invalid interval quality");this.interval=t,this.quality=e,this.direction="down"===n?"down":"up",this.simpleInterval=i,this.simpleIntervalType=a,this.compoundOctaves=r}function r(t,e){if(!(t instanceof n))return null;e=e||"",this.name=t.name.toUpperCase()+t.accidental.sign+e,this.symbol=e,this.root=t,this.notes=[t],this.quality="major";var i,r,a,s,l,h,d,u="quality",c=["M3","P5","m7","M9","P11","M13"],f=2,v=[];for(e=e.replace(/[,\s\(\)]/g,""),h=e.split("/"),2===h.length?(e=h[0],h=h[1]):h=null,i=0,r=e.length;r>i&&(a=e[i]);i++){switch(s=a.charCodeAt(i),l=r>=i+3?e.substr(i,3):null,u){case"quality":var p;l&&m[l]?(p=y[m[l]],this.quality=m[l],i+=l.length-1):m[a]&&"maj"!==l?(p=y[m[a]],this.quality=m[a]):(p=y.major,i-=1),c[0]=p[0],c[1]=p[1],u="extension";break;case"extension":if(a="1"===a&&e[i+1]?parseFloat(e.substr(i,2)):parseFloat(a),isNaN(a)||6===a)6===a?(c[2]="M6",3>f&&(f=3)):i-=1;else{if(f=(a-1)/2,f!==Math.round(f))throw Error("Invalid interval extension: "+a.toString(10));i+=(a+"").length-1}u="alterations";break;case"alterations":var g,w=e.substr(i).split(/(#|b|add|maj|sus)/),M=!1,b=!1;if(1===w.length)throw Error("Invalid alterations");if(0!==w[0].length)throw Error("Invalid token: '"+w[0]+"'");for(var P=1,I=w.length;I>P;P++)switch(g=I>P+1?w[P+1]:null,w[P]){case"maj":3>f&&(f=3),"7"===g&&P++,c[2]="M7";break;case"sus":var q="P4";("2"===g||"4"===g)&&("2"===g&&(q="M2"),P++),c[0]=q;break;case"add":g&&!isNaN(parseFloat(g))&&("9"===g?v.push("M9"):"11"===g?v.push("P11"):"13"===g&&v.push("M13"),P+=g.length);break;case"b":M=!0;break;case"#":b=!0;break;default:if(0===w[P].length)break;var A,x,k=parseFloat(w[P]),E=parseFloat(w[P]);if(isNaN(k)||(k+"").length!==w[P].length)throw Error("Invalid token: '"+w[P]+"'");if(6===k){c[2]=b?"A6":M?"m6":"M6",3>f&&(f=3);continue}if(x=(E-1)/2-1,x+1>f&&(f=x+1),5>E||7===E||x!==Math.round(x))throw Error("Invalid interval alteration: "+E.toString(10));A=c[x][0],b?"d"===A?A="m":"m"===A?A="M":("M"===A||"P"===A)&&(A="A"):M&&("A"===A?A="M":"M"===A?A="m":("m"===A||"P"===A)&&(A="d")),c[x]=A+c[x].substr(1)}u="ended"}if("ended"===u)break}if(c=c.slice(0,f).concat(v),h){h=o.note(h);var T=o.interval.between(t,h);h.octave-="up"===T.direction?1:0,this.notes.splice(0,0,h)}for(i=0;c.length>i;i++)d=this.root.interval(c[i]),h&&d.toString(!0)===h.toString(!0)||this.notes.push(d)}function a(t,e){var i,r,a;if(!(t instanceof n))throw Error("Invalid Tonic");if("string"==typeof e){if(i=e,e=o.scale.scales[e],!e)throw Error("Invalid Scale")}else for(r in o.scale.scales)if(o.scale.scales.hasOwnProperty(r)&&""+o.scale.scales[r]==""+e){i=r;break}for(this.name=i,this.notes=[],this.tonic=t,this.scale=e,r=0,a=e.length;a>r;r++)this.notes.push(o.interval(t,e[r]))}var o={},s={c:{name:"c",distance:0,index:0},d:{name:"d",distance:2,index:1},e:{name:"e",distance:4,index:2},f:{name:"f",distance:5,index:3},g:{name:"g",distance:7,index:4},a:{name:"a",distance:9,index:5},b:{name:"b",distance:11,index:6},h:{name:"h",distance:11,index:6}},l=["c","d","e","f","g","a","b"],h={.25:"longa",.5:"breve",1:"whole",2:"half",4:"quarter",8:"eighth",16:"sixteenth",32:"thirty-second",64:"sixty-fourth",128:"hundred-twenty-eighth"},d=[{name:"first",quality:"perfect",size:0},{name:"second",quality:"minor",size:1},{name:"third",quality:"minor",size:3},{name:"fourth",quality:"perfect",size:5},{name:"fifth",quality:"perfect",size:7},{name:"sixth",quality:"minor",size:8},{name:"seventh",quality:"minor",size:10},{name:"octave",quality:"perfect",size:12}],u={first:0,second:1,third:2,fourth:3,fifth:4,sixth:5,seventh:6,octave:7,ninth:8,tenth:9,eleventh:10,twelfth:11,thirteenth:12,fourteenth:13,fifteenth:14},m={P:"perfect",M:"major",m:"minor","-":"minor",A:"augmented","+":"augmented",AA:"doubly augmented",d:"diminished",dd:"doubly diminished",aug:"augmented",dim:"diminished"},c={perfect:"P",major:"M",minor:"m",augmented:"A","doubly augmented":"AA",diminished:"d","doubly diminished":"dd"},f={perfect:{"doubly diminished":-2,diminished:-1,perfect:0,augmented:1,"doubly augmented":2},minor:{"doubly diminished":-2,diminished:-1,minor:0,major:1,augmented:2,"doubly augmented":3}},v={perfect:"perfect",major:"minor",minor:"major",augmented:"diminished","doubly augmented":"doubly diminished",diminished:"augmented","doubly diminished":"doubly augmented"},p={perfect:["doubly diminished","diminished","perfect","augmented","doubly augmented"],minor:["doubly diminished","diminished","minor","major","augmented","doubly augmented"]},y={major:["M3","P5"],minor:["m3","P5"],augmented:["M3","A5"],diminished:["m3","d5"],sus2:["M2","P5"],sus4:["P4","P5"],power:["P5"]},g={major:"M",minor:"m",augmented:"aug",diminished:"dim",power:"5"},w={"-2":"bb","-1":"b",0:"",1:"#",2:"x"},M={bb:-2,b:-1,"#":1,x:2},b={first:"1",tonic:"1",second:"2",third:"3",fourth:"4",fifth:"5",sixth:"6",seventh:"7",ninth:"9",eleventh:"11",thirteenth:"13"},P={dd1:"daw",d1:"de",P1:"do",A1:"di",AA1:"dai",d2:"raw",m2:"ra",M2:"re",A2:"ri",AA2:"rai",d3:"maw",m3:"me",M3:"mi",A3:"mai",dd4:"faw",d4:"fe",P4:"fa",A4:"fi",AA4:"fai",dd5:"saw",d5:"se",P5:"so",A5:"si",AA5:"sai",d6:"law",m6:"le",M6:"la",A6:"li",AA6:"lai",d7:"taw",m7:"te",M7:"ti",A7:"tai",dd8:"daw",d8:"de",P8:"do",A8:"di",AA8:"dai"};n.prototype={key:function(t){var e;return t?(e=Math.ceil(s[this.name].distance/2),7*(this.octave-1)+3+e):(e=s[this.name].distance+this.accidental.value,12*(this.octave-1)+4+e)},fq:function(t){return t=t||440,t*Math.pow(2,(this.key()-49)/12)},scale:function(t){return o.scale(this,t)},interval:function(t,e){return o.interval(this,t,e)},transpose:function(t,e){var n=o.interval(this,t,e);return this.name=n.name,this.octave=n.octave,this.accidental=n.accidental,this},chord:function(t){return t=t||"major",t in g&&(t=g[t]),new r(this,t)},helmholtz:function(){var t=3>this.octave?this.name.toUpperCase():this.name.toLowerCase(),n=3>this.octave?",":"'",i=2>this.octave?2-this.octave:this.octave-3;return e(t+this.accidental.sign,n,i)},scientific:function(){return this.name.toUpperCase()+this.accidental.sign+this.octave},enharmonics:function(){var t=[],e=this.key(),n=this.interval("m2","up"),i=this.interval("m2","down"),r=n.key()-n.accidental.value,a=i.key()-i.accidental.value,o=e-r;return 3>o&&o>-3&&(n.accidental={value:o,sign:w[o]},t.push(n)),o=e-a,3>o&&o>-3&&(i.accidental={value:o,sign:w[o]},t.push(i)),t},solfege:function(t,n){if(!(t instanceof a))throw Error("Invalid Scale");var i,r,o,s=t.tonic.interval(this);return"down"===s.direction&&(s=s.invert()),n&&(o=(this.key(!0)-t.tonic.key(!0))/7,o=o>=0?Math.floor(o):-Math.ceil(-o),r=o>=0?"'":","),i=P[s.simple()],n?e(i,r,Math.abs(o)):i},durationName:function(){return h[this.duration.value]},durationInSeconds:function(t,e){var n=60/t/(this.duration.value/4)/(e/4);return 2*n-n/Math.pow(2,this.duration.dots)},scaleDegree:function(t){var e=t.tonic.interval(this);return e="down"===e.direction||8===e.simpleInterval?e.invert():e,t.scale.indexOf(e.simple())+1},toString:function(t){var e=t?"":this.octave;return this.name.toLowerCase()+this.accidental.sign+e}},i.prototype={semitones:function(){return this.simpleIntervalType.size+this.qualityValue()+12*this.compoundOctaves},simple:function(){return c[this.quality]+(""+this.simpleInterval)},compound:function(){return c[this.quality]+(""+(this.simpleInterval+7*this.compoundOctaves))},isCompound:function(){return this.compoundOctaves>0},invert:function(){var t=this.simpleInterval;return t=9-t,new i(t,v[this.quality])},qualityValue:function(){var t=this.simpleIntervalType.quality,e=this.quality;return f[t][e]},equal:function(t){return this.interval===t.interval&&this.quality===t.quality},greater:function(t){var e=this.semitones(),n=t.semitones();return e===n?this.interval>t.interval:e>n},smaller:function(t){return!this.equal(t)&&!this.greater(t)},toString:function(){return this.compound()}},r.prototype={dominant:function(t){return t=t||"",new r(this.root.interval("P5"),t)},subdominant:function(t){return t=t||"",new r(this.root.interval("P4"),t)},parallel:function(t){if(t=t||"","triad"!==this.chordType()||"diminished"===this.quality||"augmented"===this.quality)throw Error("Only major/minor triads have parallel chords");return"major"===this.quality?new r(this.root.interval("m3","down"),"m"):new r(this.root.interval("m3","up"))},chordType:function(){var t,e,n,i,r,a=this.notes.length;if(2===a)return"dyad";if(3===a){for(e={first:!1,third:!1,fifth:!1},i=0;a>i;i++)t=this.root.interval(this.notes[i]),n=t.invert(),t.simpleIntervalType.name in e?e[t.simpleIntervalType.name]=!0:n.simpleIntervalType.name in e&&(e[n.simpleIntervalType.name]=!0);r=e.first&&e.third&&e.fifth?"triad":"trichord"}else if(4===a){for(e={first:!1,third:!1,fifth:!1,seventh:!1},i=0;a>i;i++)t=this.root.interval(this.notes[i]),n=t.invert(),t.simpleIntervalType.name in e?e[t.simpleIntervalType.name]=!0:n.simpleIntervalType.name in e&&(e[n.simpleIntervalType.name]=!0);e.first&&e.third&&e.fifth&&e.seventh&&(r="tetrad")}return r||"unknown"},get:function(t){if("string"==typeof t&&t in b){var e=d[u[t]].quality;e="perfect"===e?"P":"M",t=this.root.interval(e+b[t]);for(var n=0,i=this.notes.length;i>n;n++)if(this.notes[n].name===t.name)return this.notes[n];return null}throw Error("Invalid interval name")},interval:function(t,e){return new r(this.root.interval(t,e),this.symbol)},transpose:function(t,e){var n=new r(this.root.interval(t,e),this.symbol);return this.name=n.name,this.symbol=n.symbol,this.root=n.root,this.notes=n.notes,this.quality=n.quality,this},toString:function(){return this.name}},a.prototype={simple:function(){for(var t=[],e=0,n=this.notes.length;n>e;e++)t.push(this.notes[e].toString(!0));return t},type:function(){var t=this.notes.length-2;return 8>t?["di","tri","tetra","penta","hexa","hepta","octa"][t]+"tonic":void 0},get:function(t){return"string"==typeof t&&t in b&&(t=parseInt(b[t],10)),this.notes[t-1]},solfege:function(t,e){var n,i,r=[];if(t)return this.get(t).solfege(this,e);for(n=0,i=this.notes.length;i>n;n++)r.push(this.notes[n].solfege(this,e));return r},interval:function(t,e){return new a(this.tonic.interval(t,e),this.scale)},transpose:function(t,e){var n=new a(this.tonic.interval(t,e),this.scale);return this.notes=n.notes,this.scale=n.scale,this.tonic=n.tonic,this}},o.note=function(t,e){return new n(t,e)},o.note.fromKey=function(t){var e=Math.floor((t-4)/12),n=t-12*e-4,i=s[l[Math.round(n/2)]],r=i.name;return n>i.distance?r+="#":i.distance>n&&(r+="b"),o.note(r+(e+1))},o.note.fromFrequency=function(t,e){var n,i,r;return e=e||440,n=49+12*((Math.log(t)-Math.log(e))/Math.log(2)),n=Math.round(n),r=e*Math.pow(2,(n-49)/12),i=1200*(Math.log(t/r)/Math.log(2)),{note:o.note.fromKey(n),cents:i}},o.note.fromMIDI=function(t){return o.note.fromKey(t-20)},o.chord=function(t,e){if("string"==typeof t){var i,a;if(i=t.match(/^([a-h])(x|#|bb|b?)/i),i&&i[0])return a="number"==typeof e?e.toString(10):"4",new r(o.note(i[0].toLowerCase()+a),t.substr(i[0].length))}else if(t instanceof n)return new r(t,e||"");throw Error("Invalid Chord. Couldn't find note name")},o.interval=function(t,e,r){var a,s,l,h=/^(AA|A|P|M|m|d|dd)(\d+)$/;if("string"==typeof t){if(h=t.match(h),!h)throw Error("Invalid string-interval format");return a=m[h[1]],s=parseInt(h[2],10),new i(s,a,e)}if("string"==typeof e&&t instanceof n){if("down"===r&&(e=o.interval.invert(e)),h=e.match(h),!h)throw Error("Invalid string-interval format");return a=m[h[1]],s=parseInt(h[2],10),l=new i(s,a,r),o.interval.from(t,l)}if(e instanceof n&&t instanceof n)return o.interval.between(t,e);throw Error("Invalid parameters")},o.interval.from=function(e,n){var i,r,a,h,d;return h=n.simpleInterval-1,h=s[e.name].index+h,h>l.length-1&&(h-=l.length),i=l[h],d=t(e.name,i),r=n.simpleIntervalType.size+n.qualityValue()-d,a=Math.floor((e.key()-e.accidental.value+d-4)/12),a+=1+Math.floor((n.simpleInterval-1)/7),a+=n.compoundOctaves,r+=e.accidental.value,r>=10&&(r-=12),i+=w[r],"down"===n.direction&&a--,o.note(i+a.toString(10))},o.interval.between=function(t,e){var n,r,a,o,s,l="up",h=1;return n=e.key()-t.key(),a=e.key(!0)-t.key(!0),0>a&&(a=-a,l="down",h=-1),r=d[a%7],s=p[r.quality],o=s[(h*n-r.size+2)%12],new i(a+1,o,l)},o.interval.invert=function(t){return""+o.interval(t).invert()},o.scale=function(t,e){return t instanceof n||(t=o.note(t)),new a(t,e)},o.scale.scales={major:["P1","M2","M3","P4","P5","M6","M7"],ionian:["P1","M2","M3","P4","P5","M6","M7"],dorian:["P1","M2","m3","P4","P5","M6","m7"],phrygian:["P1","m2","m3","P4","P5","m6","m7"],lydian:["P1","M2","M3","A4","P5","M6","M7"],mixolydian:["P1","M2","M3","P4","P5","M6","m7"],minor:["P1","M2","m3","P4","P5","m6","m7"],aeolian:["P1","M2","m3","P4","P5","m6","m7"],locrian:["P1","m2","m3","P4","d5","m6","m7"],majorpentatonic:["P1","M2","M3","P5","M6"],minorpentatonic:["P1","m3","P4","P5","m7"],chromatic:["P1","m2","M2","m3","M3","P4","A4","P5","m6","M6","m7","M7"],harmonicchromatic:["P1","m2","M2","m3","M3","P4","A4","P5","m6","M6","m7","M7"]},o.TeoriaNote=n,o.TeoriaChord=r,o.TeoriaScale=a,o.TeoriaInterval=i,"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=o),exports.teoria=o):this!==void 0?this.teoria=o:"undefined"!=typeof window&&(window.teoria=o)})();