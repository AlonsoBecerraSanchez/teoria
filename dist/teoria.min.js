(function(){"use strict";function e(e,t){return e=o[e],t=o[t],e.distance>t.distance?t.distance+12-e.distance:t.distance-e.distance}function t(e,t,n){for(;n>0;n--)e+=t;return e}function n(e,t){if("string"!=typeof e)return null;t=t||{},this.name=e,this.duration={value:t.value||4,dots:t.dots||0},this.accidental={value:0,sign:""};var n,i,a,r,o=/^([a-h])(x|#|bb|b?)(-?\d*)/i,s=/^([a-h])(x|#|bb|b?)([,\']*)$/i,l=e.match(o);if(l&&e===l[0]&&0!==l[3].length)a=l[1].toLowerCase(),r=parseInt(l[3],10),l[2].length>0&&(n=l[2].toLowerCase(),i=w[l[2]]);else{if(e=e.replace(/\u2032/g,"'").replace(/\u0375/g,","),l=e.match(s),!l||e!==l[0])throw Error("Invalid note format");if(a=l[1],r=l[3],l[2].length>0&&(n=l[2].toLowerCase(),i=w[l[2]]),0===r.length)r=a===a.toLowerCase()?3:2;else if(r.match(/^'+$/)){if(a===a.toUpperCase())throw Error("Format must respect the Helmholtz notation");r=3+r.length}else{if(!r.match(/^,+$/))throw Error("Invalid characters after note name.");if(a===a.toLowerCase())throw Error("Format must respect the Helmholtz notation");r=2-r.length}}this.name=a.toLowerCase(),this.octave=r,n&&(this.accidental.value=i,this.accidental.sign=n)}function i(e,t,n){var i=e>=8&&1===e%7?8*(e%7):(e-1)%7+1,a=Math.ceil((e-i)/8),r=d[i-1];if(!(t in u[r.quality]))throw Error("Invalid interval quality");this.interval=e,this.quality=t,this.direction="down"===n?"down":"up",this.simpleInterval=i,this.simpleIntervalType=r,this.compoundOctaves=a}function a(e,t){function i(e){for(var t=0,n=e.length;n>t;t++)f[t]=e[t];v=e.length}if(!(e instanceof n))return null;t=t||"",this.name=e.name.toUpperCase()+e.accidental.sign+t,this.symbol=t,this.root=e,this.notes=[e];var a,o,s,l,d,h,m,c="quality",u=[],f=["M3","P5","m7","M9","P11","M13"],v=2;for(t=t.replace(/[,\s\(\)]/g,""),d=t.split("/"),2===d.length?(t=d[0],d=d[1]):d=null,a=0,o=t.length;o>a&&(s=t[a]);a++){switch(c){case"quality":l=o>=a+3?t.substr(a,3):null,m=l in p?l:s in p?s:"",i(p[m]),a+=m.length-1,c="extension";break;case"extension":if(s="1"===s&&t[a+1]?parseFloat(t.substr(a,2)):parseFloat(s),isNaN(s)||6===s)6===s?(f[2]="M6",v=3>v?3:v):a-=1;else{if(v=(s-1)/2,v!==Math.round(v))throw Error("Invalid interval extension: "+s.toString(10));("o"===m||"dim"===m)&&(f[2]="d7"),a+=(s+"").length-1}c="alterations";break;case"alterations":var y,g=t.substr(a).split(/(#|b|add|maj|sus|M)/),w=!1,M=!1;if(1===g.length)throw Error("Invalid alterations");if(0!==g[0].length)throw Error("Invalid token: '"+g[0]+"'");for(var b=1,P=g.length;P>b;b++)switch(y=g[b+1],g[b]){case"M":case"maj":v=3>v?3:v,"7"===y&&b++,f[2]="M7";break;case"sus":var I="P4";("2"===y||"4"===y)&&(b++,"2"===y&&(I="M2")),f[0]=I;break;case"add":y&&!isNaN(parseInt(y,10))&&("9"===y?u.push("M9"):"11"===y?u.push("P11"):"13"===y&&u.push("M13"),b+=y.length);break;case"b":w=!0;break;case"#":M=!0;break;default:if(0===g[b].length)break;var A,q,x=parseInt(g[b],10),k=parseInt(g[b],10);if(isNaN(x)||(x+"").length!==g[b].length)throw Error("Invalid token: '"+g[b]+"'");if(6===x){f[2]=M?"A6":w?"m6":"M6",v=3>v?3:v;continue}if(q=(k-1)/2-1,q+1>v&&(v=q+1),5>k||7===k||q!==Math.round(q))throw Error("Invalid interval alteration: "+k.toString(10));A=f[q][0],M?"d"===A?A="m":"m"===A?A="M":("M"===A||"P"===A)&&(A="A"):w&&("A"===A?A="M":"M"===A?A="m":("m"===A||"P"===A)&&(A="d")),f[q]=A+k}c="ended"}if("ended"===c)break}if(f=f.slice(0,v).concat(u),d){d=r.note(d);var T=r.interval.between(e,d);d.octave-="up"===T.direction?1:0,this.notes.splice(0,0,d)}for(a=0;f.length>a;a++)h=this.root.interval(f[a]),d&&h.toString(!0)===d.toString(!0)||this.notes.push(h)}var r={},o={c:{name:"c",distance:0,index:0},d:{name:"d",distance:2,index:1},e:{name:"e",distance:4,index:2},f:{name:"f",distance:5,index:3},g:{name:"g",distance:7,index:4},a:{name:"a",distance:9,index:5},b:{name:"b",distance:11,index:6},h:{name:"h",distance:11,index:6}},s=["c","d","e","f","g","a","b"],l={.25:"longa",.5:"breve",1:"whole",2:"half",4:"quarter",8:"eighth",16:"sixteenth",32:"thirty-second",64:"sixty-fourth",128:"hundred-twenty-eighth"},d=[{name:"first",quality:"perfect",size:0},{name:"second",quality:"minor",size:1},{name:"third",quality:"minor",size:3},{name:"fourth",quality:"perfect",size:5},{name:"fifth",quality:"perfect",size:7},{name:"sixth",quality:"minor",size:8},{name:"seventh",quality:"minor",size:10},{name:"octave",quality:"perfect",size:12}],h={first:0,second:1,third:2,fourth:3,fifth:4,sixth:5,seventh:6,octave:7,ninth:8,tenth:9,eleventh:10,twelfth:11,thirteenth:12,fourteenth:13,fifteenth:14},m={P:"perfect",M:"major",m:"minor","-":"minor",A:"augmented","+":"augmented",AA:"doubly augmented",d:"diminished",dd:"doubly diminished",min:"minor",aug:"augmented",dim:"diminished"},c={perfect:"P",major:"M",minor:"m",augmented:"A","doubly augmented":"AA",diminished:"d","doubly diminished":"dd"},u={perfect:{"doubly diminished":-2,diminished:-1,perfect:0,augmented:1,"doubly augmented":2},minor:{"doubly diminished":-2,diminished:-1,minor:0,major:1,augmented:2,"doubly augmented":3}},f={perfect:"perfect",major:"minor",minor:"major",augmented:"diminished","doubly augmented":"doubly diminished",diminished:"augmented","doubly diminished":"doubly augmented"},v={perfect:["doubly diminished","diminished","perfect","augmented","doubly augmented"],minor:["doubly diminished","diminished","minor","major","augmented","doubly augmented"]},p={min:["m3","P5"],m:["m3","P5"],"-":["m3","P5"],M:["M3","P5"],"":["M3","P5"],"+":["M3","A5"],aug:["M3","A5"],dim:["m3","d5"],o:["m3","d5"],maj:["M3","P5","M7"],dom:["M3","P5","m7"],"Ã¸":["m3","d5","m7"]},y={major:"M",minor:"m",augmented:"aug",diminished:"dim",power:"5"},g={"-2":"bb","-1":"b",0:"",1:"#",2:"x"},w={bb:-2,b:-1,"#":1,x:2},M={first:"1",tonic:"1",second:"2",third:"3",fourth:"4",fifth:"5",sixth:"6",seventh:"7",ninth:"9",eleventh:"11",thirteenth:"13"},b={dd1:"daw",d1:"de",P1:"do",A1:"di",AA1:"dai",d2:"raw",m2:"ra",M2:"re",A2:"ri",AA2:"rai",d3:"maw",m3:"me",M3:"mi",A3:"mai",dd4:"faw",d4:"fe",P4:"fa",A4:"fi",AA4:"fai",dd5:"saw",d5:"se",P5:"so",A5:"si",AA5:"sai",d6:"law",m6:"le",M6:"la",A6:"li",AA6:"lai",d7:"taw",m7:"te",M7:"ti",A7:"tai",dd8:"daw",d8:"de",P8:"do",A8:"di",AA8:"dai"};r.note=function(e,t){return new n(e,t)},r.note.fromKey=function(e){var t=Math.floor((e-4)/12),n=e-12*t-4,i=o[s[Math.round(n/2)]],a=i.name;return n>i.distance?a+="#":i.distance>n&&(a+="b"),r.note(a+(t+1))},r.note.fromFrequency=function(e,t){var n,i,a;return t=t||440,n=49+12*((Math.log(e)-Math.log(t))/Math.log(2)),n=Math.round(n),a=t*Math.pow(2,(n-49)/12),i=1200*(Math.log(e/a)/Math.log(2)),{note:r.note.fromKey(n),cents:i}},r.note.fromMIDI=function(e){return r.note.fromKey(e-20)},r.chord=function(e,t){if("string"==typeof e){var i,o;if(i=e.match(/^([a-h])(x|#|bb|b?)/i),i&&i[0])return o="number"==typeof t?t.toString(10):"4",new a(r.note(i[0].toLowerCase()+o),e.substr(i[0].length))}else if(e instanceof n)return new a(e,t||"");throw Error("Invalid Chord. Couldn't find note name")},r.interval=function(e,t,a){var o,s,l,d=/^(AA|A|P|M|m|d|dd)(\d+)$/;if("string"==typeof e){if(d=e.match(d),!d)throw Error("Invalid string-interval format");return o=m[d[1]],s=parseInt(d[2],10),new i(s,o,t)}if("string"==typeof t&&e instanceof n){if("down"===a&&(t=r.interval.invert(t)),d=t.match(d),!d)throw Error("Invalid string-interval format");return o=m[d[1]],s=parseInt(d[2],10),l=new i(s,o,a),r.interval.from(e,l)}if(t instanceof n&&e instanceof n)return r.interval.between(e,t);throw Error("Invalid parameters")},r.interval.from=function(t,n){var i,a,l,d,h;return d=n.simpleInterval-1,d=o[t.name].index+d,d>s.length-1&&(d-=s.length),i=s[d],h=e(t.name,i),a=n.simpleIntervalType.size+n.qualityValue()-h,l=Math.floor((t.key()-t.accidental.value+h-4)/12),l+=1+Math.floor((n.simpleInterval-1)/7),l+=n.compoundOctaves,a+=t.accidental.value,a>=10&&(a-=12),i+=g[a],"down"===n.direction&&l--,r.note(i+l.toString(10))},r.interval.between=function(e,t){var n,a,r,o,s,l="up",h=1;return n=t.key()-e.key(),r=t.key(!0)-e.key(!0),0>r&&(r=-r,l="down",h=-1),a=d[r%7],s=v[a.quality],o=s[(h*n-a.size+2)%12],new i(r+1,o,l)},r.interval.invert=function(e){return""+r.interval(e).invert()},r.scale=function(e,t){return e instanceof n||(e=r.note(e)),new TeoriaScale(e,t)},n.prototype={key:function(e){var t;return e?(t=Math.ceil(o[this.name].distance/2),7*(this.octave-1)+3+t):(t=o[this.name].distance+this.accidental.value,12*(this.octave-1)+4+t)},fq:function(e){return e=e||440,e*Math.pow(2,(this.key()-49)/12)},chroma:function(){var e=(o[this.name].distance+this.accidental.value)%12;return 0>e?e+12:e},scale:function(e){return r.scale(this,e)},interval:function(e,t){return r.interval(this,e,t)},transpose:function(e,t){var n=r.interval(this,e,t);return this.name=n.name,this.octave=n.octave,this.accidental=n.accidental,this},chord:function(e){return e=e||"major",e in y&&(e=y[e]),new a(this,e)},helmholtz:function(){var e=3>this.octave?this.name.toUpperCase():this.name.toLowerCase(),n=3>this.octave?",":"'",i=2>this.octave?2-this.octave:this.octave-3;return t(e+this.accidental.sign,n,i)},scientific:function(){return this.name.toUpperCase()+this.accidental.sign+this.octave},enharmonics:function(){var e=[],t=this.key(),n=this.interval("m2","up"),i=this.interval("m2","down"),a=n.key()-n.accidental.value,r=i.key()-i.accidental.value,o=t-a;return 3>o&&o>-3&&(n.accidental={value:o,sign:g[o]},e.push(n)),o=t-r,3>o&&o>-3&&(i.accidental={value:o,sign:g[o]},e.push(i)),e},solfege:function(e,n){if(!(e instanceof TeoriaScale))throw Error("Invalid Scale");var i,a,r,o=e.tonic.interval(this);return"down"===o.direction&&(o=o.invert()),n&&(r=(this.key(!0)-e.tonic.key(!0))/7,r=r>=0?Math.floor(r):-Math.ceil(-r),a=r>=0?"'":","),i=b[o.simple()],n?t(i,a,Math.abs(r)):i},durationName:function(){return l[this.duration.value]},durationInSeconds:function(e,t){var n=60/e/(this.duration.value/4)/(t/4);return 2*n-n/Math.pow(2,this.duration.dots)},scaleDegree:function(e){var t=e.tonic.interval(this);return t="down"===t.direction||8===t.simpleInterval?t.invert():t,e.scale.indexOf(t.simple())+1},toString:function(e){var t=e?"":this.octave;return this.name.toLowerCase()+this.accidental.sign+t}},i.prototype={semitones:function(){return this.simpleIntervalType.size+this.qualityValue()+12*this.compoundOctaves},simple:function(){return c[this.quality]+(""+this.simpleInterval)},compound:function(){return c[this.quality]+(""+(this.simpleInterval+7*this.compoundOctaves))},isCompound:function(){return this.compoundOctaves>0},invert:function(){var e=this.simpleInterval;return e=9-e,new i(e,f[this.quality])},qualityValue:function(){var e=this.simpleIntervalType.quality,t=this.quality;return u[e][t]},equal:function(e){return this.interval===e.interval&&this.quality===e.quality},greater:function(e){var t=this.semitones(),n=e.semitones();return t===n?this.interval>e.interval:t>n},smaller:function(e){return!this.equal(e)&&!this.greater(e)},toString:function(){return this.compound()}},a.prototype={dominant:function(e){return e=e||"",new a(this.root.interval("P5"),e)},subdominant:function(e){return e=e||"",new a(this.root.interval("P4"),e)},parallel:function(e){e=e||"";var t=this.quality();if("triad"!==this.chordType()||"diminished"===t||"augmented"===t)throw Error("Only major/minor triads have parallel chords");return"major"===t?new a(this.root.interval("m3","down"),"m"):new a(this.root.interval("m3","up"))},quality:function(){var e=this.get("third"),t=this.get("fifth"),n=this.get("seventh");if(e)return e=this.root.interval(e),e="down"===e.direction?e.invert():e,e=e.simple(),t&&(t=this.root.interval(t),t="down"===t.direction?t.invert():t,t=t.simple()),n&&(n=this.root.interval(n),n="down"===n.direction?n.invert():n,n=n.simple()),"M3"===e?"A5"===t?"augmented":"P5"===t?"m7"===n?"dominant":"major":"major":"m3"===e?"P5"===t?"minor":"d5"===t?"m7"===n?"half-diminished":"diminished":"minor":void 0},chordType:function(){var e,t,n,i,a,r=this.notes.length;if(2===r)return"dyad";if(3===r){for(t={first:!1,third:!1,fifth:!1},i=0;r>i;i++)e=this.root.interval(this.notes[i]),n=e.invert(),e.simpleIntervalType.name in t?t[e.simpleIntervalType.name]=!0:n.simpleIntervalType.name in t&&(t[n.simpleIntervalType.name]=!0);a=t.first&&t.third&&t.fifth?"triad":"trichord"}else if(4===r){for(t={first:!1,third:!1,fifth:!1,seventh:!1},i=0;r>i;i++)e=this.root.interval(this.notes[i]),n=e.invert(),e.simpleIntervalType.name in t?t[e.simpleIntervalType.name]=!0:n.simpleIntervalType.name in t&&(t[n.simpleIntervalType.name]=!0);t.first&&t.third&&t.fifth&&t.seventh&&(a="tetrad")}return a||"unknown"},get:function(e){if("string"==typeof e&&e in M){var t=d[h[e]].quality;t="perfect"===t?"P":"M",e=this.root.interval(t+M[e]);for(var n=0,i=this.notes.length;i>n;n++)if(this.notes[n].name===e.name)return this.notes[n];return null}throw Error("Invalid interval name")},interval:function(e,t){return new a(this.root.interval(e,t),this.symbol)},transpose:function(e,t){var n=new a(this.root.interval(e,t),this.symbol);return this.name=n.name,this.symbol=n.symbol,this.root=n.root,this.notes=n.notes,this},toString:function(){return this.name}},r.scale.scales.ionian=r.scale.scales.major=["P1","M2","M3","P4","P5","M6","M7"],r.scale.scales.dorian=["P1","M2","m3","P4","P5","M6","m7"],r.scale.scales.phrygian=["P1","m2","m3","P4","P5","m6","m7"],r.scale.scales.lydian=["P1","M2","M3","A4","P5","M6","M7"],r.scale.scales.mixolydian=["P1","M2","M3","P4","P5","M6","m7"],r.scale.scales.aeolian=["P1","M2","m3","P4","P5","m6","m7"],r.scale.scales.locrian=["P1","m2","m3","P4","d5","m6","m7"],r.scale.scales.majorpentatonic=["P1","M2","M3","P5","M6"],r.scale.scales.minorpentatonic=["P1","m3","P4","P5","m7"],r.scale.scales.chromatic=r.scale.scales.harmonicchromatic=["P1","m2","M2","m3","M3","P4","A4","P5","m6","M6","m7","M7"],r.TeoriaNote=n,r.TeoriaChord=a,r.TeoriaScale=TeoriaScale,r.TeoriaInterval=i,"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=r),exports.teoria=r):this!==void 0?this.teoria=r:"undefined"!=typeof window&&(window.teoria=r)})();